#cloud-config
package_update: true
packages:
  - ufw
  - fail2ban
  - ca-certificates
  - curl
  - iptables-persistent
  - netfilter-persistent

write_files:
  # Root key SSH so we can run the upstream script as root (unchanged)
  - path: /root/.ssh/authorized_keys
    permissions: '0600'
    owner: root:root
    content: |
      ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAACAQC9ZwxLDRko+ufo7kp5nEAavu3OnvNnJXVc6wqt9q61CU77W8q926bG40ScahG8QUyYJfJI1eg2oLrouugiV+PX7tqOO1hKmm1rqrjX+a8QWydKa8hViFnJbHqQCV+OBoO+nUJFQVwBBrA17UkKLN49u695FzHe3UBFAXLgezk+ukQt0zPRwe35Hr3lhS5viw4rzInWFutC5SsCNNuRPj1zLo1bH5uyRV4w6EJMm0xr3PltHVA0ZQEJQiMQr7hHmjhCFShIB1VXcf02q1RSbNJYOomeYnOfb3izmIY97ucg5H0o0puGQoF4yRgDCCOOMg2J8IeRjnkg3bAV4hM8lQ6tus4kDUUTj6SDPVnqO11LsCBMbp5Rh6kT5js21V0SC5MRCzJgVVvG5c7y0Ba+9OVwEhxXvmXiA0dpP4cOCtbunQ81xYK0+c+/OAw2ChitZVbTx3yWKVNy5t0qjbY5HsBrFIlEBSrSPwy1kvklNKS2/8phg43ojTVC0rPdkJn+wDY+9u+fjdUbDqZlbNzXMsB+rcE5aF42dHiw47zJaENE79zcQjKvPF3MiBdZayJAOifQl4iDvEJQC5ulPEnEoIHGIDfASVJ5ip08UVar1MVzOxv0PhJCFtEfr01jberhcv3yKNvxSTKKFWAgKx/WfTtt8+rjze7Gicciae2K/KfFVw== dokploy-test

  # Temporary file for ubuntu SSH keys (will be copied in runcmd)
  - path: /tmp/ubuntu_authorized_keys.txt
    permissions: '0600'
    owner: root:root
    content: |
      ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAACAQC9ZwxLDRko+ufo7kp5nEAavu3OnvNnJXVc6wqt9q61CU77W8q926bG40ScahG8QUyYJfJI1eg2oLrouugiV+PX7tqOO1hKmm1rqrjX+a8QWydKa8hViFnJbHqQCV+OBoO+nUJFQVwBBrA17UkKLN49u695FzHe3UBFAXLgezk+ukQt0zPRwe35Hr3lhS5viw4rzInWFutC5SsCNNuRPj1zLo1bH5uyRV4w6EJMm0xr3PltHVA0ZQEJQiMQr7hHmjhCFShIB1VXcf02q1RSbNJYOomeYnOfb3izmIY97ucg5H0o0puGQoF4yRgDCCOOMg2J8IeRjnkg3bAV4hM8lQ6tus4kDUUTj6SDPVnqO11LsCBMbp5Rh6kT5js21V0SC5MRCzJgVVvG5c7y0Ba+9OVwEhxXvmXiA0dpP4cOCtbunQ81xYK0+c+/OAw2ChitZVbTx3yWKVNy5t0qjbY5HsBrFIlEBSrSPwy1kvklNKS2/8phg43ojTVC0rPdkJn+wDY+9u+fjdUbDqZlbNzXMsB+rcE5aF42dHiw47zJaENE79zcQjKvPF3MiBdZayJAOifQl4iDvEJQC5ulPEnEoIHGIDfASVJ5ip08UVar1MVzOxv0PhJCFtEfr01jberhcv3yKNvxSTKKFWAgKx/WfTtt8+rjze7Gicciae2K/KfFVw== dokploy-test

  # Temporary file for worker IPs (will be copied in runcmd)
  - path: /tmp/worker_ips.txt
    permissions: '0600'
    owner: root:root
    content: |
      172.28.0.11
      172.28.0.12

  # SSH hardening expected by Dokploy's checks
  - path: /etc/ssh/sshd_config.d/99-dokploy-hardening.conf
    permissions: '0644'
    owner: root:root
    content: |
      PubkeyAuthentication yes
      PasswordAuthentication no
      KbdInteractiveAuthentication no
      ChallengeResponseAuthentication no
      UsePAM no
      PermitRootLogin prohibit-password

  # Fail2Ban: protect SSH aggressively
  - path: /etc/fail2ban/jail.d/sshd.local
    permissions: '0644'
    owner: root:root
    content: |
      [sshd]
      enabled = true
      backend = systemd
      mode = aggressive
      maxretry = 5
      findtime = 10m
      bantime = 1h
      port = ssh

  # Orchestrator: ensures manager is set up, then joins workers
  - path: /usr/local/sbin/swarm-join-workers.sh
    permissions: '0755'
    owner: root:root
    content: |
      #!/usr/bin/env bash
      set -euo pipefail
      log=/var/log/swarm-join-workers.log
      exec > >(tee -a "$log") 2>&1
      echo "== $(date -Is) starting swarm orchestration =="

      # 1) Run upstream Dokploy script on the manager (unchanged)
      if ! command -v docker >/dev/null 2>&1; then
        echo "Installing Dokploy..."
        curl -fsSL https://dokploy.com/install.sh | sh
      fi

      # 2) Ensure swarm is initialized (script usually does; this is idempotent)
      docker swarm init --advertise-addr "$(curl -4s https://ifconfig.io || hostname -I | awk '{print $1}')" >/dev/null 2>&1 || true

      # 3) Get token + manager public IP (keep consistent with upstream get_ip behavior)
      TOKEN="$(docker swarm join-token -q worker)"
      MGR_PUB="$(curl -4s https://ifconfig.io || hostname -I | awk '{print $1}')"

      # 4) Join each worker (as root), ensuring Docker present and worker not in its own swarm
      FILE="/etc/swarm/workers-public.txt"
      [ -s "$FILE" ] || exit 0

      while read -r WIP; do
        [ -z "$WIP" ] && continue
        echo "Joining worker $WIP ..."
        for i in $(seq 1 18); do
          if ssh -o StrictHostKeyChecking=no -o ConnectTimeout=5 root@"$WIP" \
            "docker version >/dev/null 2>&1 || (curl -fsSL https://dokploy.com/install.sh | sh); \
             docker swarm leave --force >/dev/null 2>&1 || true; \
             docker swarm join --advertise-addr $WIP --token $TOKEN $MGR_PUB:2377"; then
            echo "OK: $WIP"; break
          fi
          echo "  retry $i for $WIP ..."; sleep 10
        done
      done < "$FILE"

      echo "== $(date -Is) swarm orchestration complete =="

  # One-shot unit to run the orchestrator once networking is up
  - path: /etc/systemd/system/swarm-join-workers.service
    permissions: '0644'
    owner: root:root
    content: |
      [Unit]
      Description=Dokploy manager: auto-join workers to swarm
      After=network.target cloud-init.target

      [Service]
      Type=oneshot
      ExecStart=/usr/local/sbin/swarm-join-workers.sh
      Restart=on-failure
      RestartSec=15

      [Install]
      WantedBy=multi-user.target

runcmd:
  # Set up ubuntu user SSH keys (must be in runcmd, not write_files, as ubuntu user exists later)
  - mkdir -p /home/ubuntu/.ssh
  - cp /tmp/ubuntu_authorized_keys.txt /home/ubuntu/.ssh/authorized_keys
  - chown -R ubuntu:ubuntu /home/ubuntu/.ssh
  - chmod 700 /home/ubuntu/.ssh
  - chmod 600 /home/ubuntu/.ssh/authorized_keys
  - rm -f /tmp/ubuntu_authorized_keys.txt

  # Create worker IPs file (copy from write_files to avoid YAML injection issues)
  - mkdir -p /etc/swarm
  - cp /tmp/worker_ips.txt /etc/swarm/workers-public.txt
  - rm -f /tmp/worker_ips.txt

  # UFW defaults + allows (keeps Security tab green)
  - ufw --force reset
  - ufw default deny incoming
  - ufw default allow outgoing
  - ufw allow 22/tcp
  - ufw allow 80/tcp
  - ufw allow 443/tcp
  - ufw allow 443/udp
  - ufw allow 3000/tcp
  - ufw allow 2377/tcp
  - ufw allow 7946/tcp
  - ufw allow 7946/udp
  - ufw allow 4789/udp
  - ufw --force enable

  # Fail2Ban on
  - systemctl enable --now fail2ban

  # Reload SSH after keys are in place (config was written by write_files earlier)
  - systemctl reload ssh || systemctl reload sshd

  # Start swarm orchestration
  - systemctl daemon-reload
  - systemctl enable --now swarm-join-workers.service
